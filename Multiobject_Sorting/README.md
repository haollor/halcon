# 多目标检测与分拣系统

基于C#和Halcon的多目标检测程序，支持HSV颜色分割、九点标定、位置角度计算，并可通过TCP/IP或Modbus协议将坐标数据发送给PLC。

## 功能特性

### 🔍 图像处理与检测
- **HSV颜色分割**：基于HSV色彩空间的精确颜色分割
- **多目标检测**：同时检测多个目标物体
- **位置角度计算**：计算目标的中心坐标和旋转角度
- **形状识别**：基于几何特征识别圆形、长方形等形状
- **模板匹配**：支持基于模板的目标检测

### 📐 坐标标定
- **九点标定算法**：使用最小二乘法进行仿射变换标定
- **图像坐标转换**：将图像坐标转换为真实世界坐标
- **标定精度计算**：实时显示标定精度
- **标定数据保存/加载**：支持XML格式的标定数据持久化

### 🔌 PLC通信
- **TCP/IP通信**：支持以太网TCP/IP协议
- **Modbus RTU/TCP**：支持Modbus串口和网络通信
- **心跳机制**：确保通信稳定性
- **数据格式化**：自动将检测结果格式化为PLC可读格式

### 🖥️ 用户界面
- **实时图像显示**：使用Halcon窗口控件显示图像
- **参数配置**：可视化的HSV参数调节
- **检测结果显示**：列表形式显示所有检测结果
- **标定界面**：交互式的标定点设置
- **状态监控**：实时显示系统状态和通信状态

## 系统要求

### 软件环境
- Windows 10/11 操作系统
- .NET Framework 4.6.1 或更高版本
- MVTec HALCON 25.05 或兼容版本
- Visual Studio 2017 或更高版本（开发环境）

### 硬件要求
- CPU：Intel i5 或同等性能处理器
- 内存：8GB RAM 推荐
- 显卡：支持DirectX 11
- 相机：USB/工业相机（可选）

## 安装部署

### 1. HALCON安装
```bash
# 下载并安装MVTec HALCON
# 确保安装了.NET接口组件
# 验证halcondotnet.dll路径正确
```

### 2. 项目编译
```bash
# 克隆项目
git clone [项目地址]

# 打开解决方案
# 在Visual Studio中打开 Multiobject_Sorting.sln

# 还原NuGet包
# 编译项目（建议使用x64平台）
```

### 3. 配置文件
编辑 `App.config` 文件，设置相关参数：
```xml
<!-- HSV参数 -->
<add key="HSV_HueMin" value="0" />
<add key="HSV_HueMax" value="180" />

<!-- PLC通信设置 -->
<add key="PLC_IPAddress" value="192.168.1.100" />
<add key="PLC_Port" value="502" />
```

## 使用指南

### 1. 系统初始化
1. 启动程序
2. 检查Halcon窗口是否正常显示
3. 确认相机连接（如果使用相机）

### 2. HSV参数设置
1. 点击"加载图像"或"相机采集"获取图像
2. 点击"HSV参数"按钮调整颜色分割参数
3. 调节色调(H)、饱和度(S)、亮度(V)范围
4. 设置最小/最大面积过滤噪点

### 3. 坐标标定
1. 点击"开始标定"进入标定模式
2. 在图像中点击标定点（建议9个点，最少4个）
3. 为每个点输入对应的真实世界坐标
4. 点击"执行标定"完成标定
5. 保存标定数据供后续使用

### 4. 目标检测
1. 确保已完成HSV参数设置和坐标标定
2. 点击"单次检测"进行单次检测
3. 或点击"自动模式"开启连续检测
4. 检测结果将显示在结果列表中

### 5. PLC通信
1. 点击"通信配置"设置PLC连接参数
2. 选择通信类型（TCP/IP或Modbus）
3. 输入IP地址、端口等连接参数
4. 点击"连接"建立与PLC的通信
5. 检测结果将自动发送到PLC

## 数据格式

### 检测结果数据结构
```csharp
public struct CoordinateData
{
    public float X;         // X坐标 (mm)
    public float Y;         // Y坐标 (mm)  
    public float Angle;     // 角度 (度)
    public int ObjectType;  // 目标类型编号
    public bool IsValid;    // 数据有效性
}
```

### TCP/IP数据包格式
```
[包头2字节][数量2字节][坐标数据...][校验和1字节]
```

### Modbus寄存器映射
- 寄存器0：数据数量
- 寄存器1-2：第一个目标X坐标（32位浮点）
- 寄存器3-4：第一个目标Y坐标（32位浮点）
- 寄存器5-6：第一个目标角度（32位浮点）
- 寄存器7：目标类型
- 寄存器8：有效性标志

## 故障排除

### 常见问题

**1. Halcon初始化失败**
- 检查HALCON是否正确安装
- 验证halcondotnet.dll路径
- 确认许可证有效

**2. 相机连接失败**
- 检查相机驱动是否正确安装
- 确认设备管理器中相机状态
- 尝试其他相机接口参数

**3. PLC通信异常**
- 验证网络连接和IP地址
- 检查防火墙设置
- 确认PLC端口开放状态

**4. 检测精度不佳**
- 重新调整HSV参数
- 改善光照条件
- 重新进行坐标标定

### 日志信息
程序运行时会在状态栏显示详细的状态信息，包括：
- 图像加载状态
- 检测结果统计
- PLC通信状态
- 错误信息提示

## 技术支持

如遇到技术问题，请提供：
1. 详细的错误信息
2. 系统环境信息
3. 操作步骤描述
4. 相关配置文件

## 版本历史

### v1.0.0
- 实现基础的HSV颜色分割功能
- 完成九点标定算法
- 支持TCP/IP和Modbus通信
- 提供完整的用户界面

## 许可证

本项目采用MIT许可证，详见LICENSE文件。

## 贡献指南

欢迎提交Issue和Pull Request来改进本项目。

## 联系方式

- 项目维护者：[姓名]
- 邮箱：[邮箱地址]
- 技术支持：[支持渠道]