# NModbus4 安装指南

## 当前项目状态
✅ **已配置**：项目文件中已包含NModbus4包引用 (Version 2.1.0)  
⚠️ **需要操作**：需要还原/安装NuGet包到本地

## 安装方法

### 方法1：Visual Studio NuGet包管理器 (推荐)

1. **打开项目**
   - 启动Visual Studio
   - 打开 `Multiobject_Sorting.sln`

2. **还原NuGet包**
   - 右键点击解决方案
   - 选择"还原NuGet程序包"
   - 等待下载完成

3. **验证安装**
   - 查看"引用"节点下是否出现NModbus4
   - 编译项目确保无错误

### 方法2：包管理器控制台

1. **打开控制台**
   - 工具 → NuGet包管理器 → 程序包管理器控制台

2. **运行命令**
   ```powershell
   # 还原所有包
   Update-Package -reinstall
   
   # 或者单独安装NModbus4
   Install-Package NModbus4 -Version 2.1.0
   ```

### 方法3：手动下载DLL

如果NuGet不可用，可以手动下载：

1. **下载NModbus4**
   - 访问：https://www.nuget.org/packages/NModbus4/2.1.0
   - 点击"Download package"下载 .nupkg 文件

2. **解压获取DLL**
   ```
   NModbus4.2.1.0.nupkg (重命名为.zip)
   └── lib/
       ├── net40/
       │   └── NModbus4.dll
       └── netstandard2.0/
           └── NModbus4.dll
   ```

3. **添加引用**
   - 复制 `NModbus4.dll` 到项目的 `bin` 或 `lib` 目录
   - 右键项目 → 添加 → 引用 → 浏览
   - 选择DLL文件并添加

### 方法4：修改项目文件（.NET Framework项目）

对于旧版本项目格式，可以改用packages.config：

1. **创建packages.config**
   ```xml
   <?xml version="1.0" encoding="utf-8"?>
   <packages>
     <package id="NModbus4" version="2.1.0" targetFramework="net461" />
   </packages>
   ```

2. **修改项目文件**
   - 移除 `<PackageReference Include="NModbus4" Version="2.1.0" />`
   - 添加传统引用：
   ```xml
   <Reference Include="NModbus4">
     <HintPath>..\packages\NModbus4.2.1.0\lib\net40\NModbus4.dll</HintPath>
   </Reference>
   ```

## 验证安装

### 编译测试
编译项目，确保没有以下错误：
- "找不到类型或命名空间名称'Modbus'"
- "未能找到文件或程序集'NModbus4'"

### 代码测试
在程序中添加测试代码：
```csharp
using Modbus.Device;
using Modbus.Serial;

// 测试Modbus RTU
try
{
    var port = new SerialPort("COM1");
    var master = ModbusSerialMaster.CreateRtu(port);
    Console.WriteLine("NModbus4安装成功！");
}
catch (Exception ex)
{
    Console.WriteLine($"测试失败: {ex.Message}");
}
```

## 常见问题

### 问题1：找不到NModbus4命名空间
**解决方案**：
- 确认DLL已正确引用
- 检查目标框架版本兼容性
- 清理并重新生成解决方案

### 问题2：版本冲突
**解决方案**：
- 统一使用NModbus4 v2.1.0
- 避免同时引用NModbus和NModbus4

### 问题3：运行时找不到程序集
**解决方案**：
- 确认DLL已复制到输出目录
- 检查app.config中的绑定重定向
- 使用"复制本地=True"

## 依赖项

NModbus4 v2.1.0 依赖：
- .NET Framework 4.0+ 或 .NET Standard 2.0+
- System.IO.Ports (串口通信)

## 技术支持

如果遇到安装问题：
1. 检查Visual Studio版本和.NET Framework版本
2. 尝试清理NuGet缓存：`nuget locals all -clear`
3. 重新下载项目并还原包
4. 查看Visual Studio输出窗口的详细错误信息

## 项目中的使用

安装完成后，项目中的Modbus功能包括：
- **Modbus RTU**：串口通信 (COM端口)
- **Modbus TCP**：网络通信 (IP:502)
- **数据读写**：保持寄存器、线圈操作
- **异步通信**：支持async/await模式

相关文件：
- `PLCCommunication.cs` - Modbus通信实现
- `App.config` - 通信参数配置